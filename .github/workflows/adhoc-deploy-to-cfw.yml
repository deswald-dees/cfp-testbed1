name: Adhoc Deploy To Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Exclude specific files/patterns from deployment directory
        run: |
          # Remove files or directories that should not be deployed
          rm -rf .github
          rm -f .gitignore LICENSE
      - name: Install Wrangler CLI
        run: npm install -g wrangler@4.49.0
      - name: Publish to Cloudflare Pages
        run: |
          PROJECT_NAME=cfp-testbed1
          BUILD_DIR="./" # Change to your build directory
          
          echo "Attempting to create project $PROJECT_NAME..."
          # The '|| true' operator is used here in a proper shell context
          npx wrangler pages project create $PROJECT_NAME \
            --production-branch=main || true
          
          echo "Starting deployment to $PROJECT_NAME..."
          # Then run the deploy command using the standard wrangler CLI command
          npx wrangler pages --config=./wrangler.yoml \
            deploy $BUILD_DIR \
            --project-name=$PROJECT_NAME \
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_USER_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # Pass the GITHUB_TOKEN as an environment variable to allow the deployment action 
          # to update GitHub deployment status (if using npx wrangler deploy directly)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
